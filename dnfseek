#!/bin/bash
# dnf-fzf: pacseek-like package browser for Fedora

while true; do
  # ===== MAIN MENU =====
  mode=$(printf "ğŸ” Search all packages\nğŸ“— Show installed packages\nâŒ Quit" | \
    fzf --prompt="Main Menu: " \
        --header=$'â¬†â¬‡ Navigate | â Select | Ctrl-C Quit' \
        --height=20% \
        --reverse)

  case "$mode" in
    "âŒ Quit" | "") exit 0 ;;
    "ğŸ“— Show installed packages") show_installed_only=true ;;
    "ğŸ” Search all packages") show_installed_only=false ;;
  esac

  # ===== PACKAGE LIST =====
  installed=$(dnf list --installed 2>/dev/null | \
    grep -vE '^(Installed|Available) Packages' | \
    awk '{print $1}')

  if [ "$show_installed_only" = true ]; then
    package_list=$(
      for p in $installed; do
        echo -e "\e[32m$p âœ…\e[0m"
      done
    )
  else
    available=$(dnf list --available 2>/dev/null | \
      grep -vE '^(Installed|Available) Packages' | \
      awk '{print $1}' | grep -vxFf <(echo "$installed"))
    package_list=$(
      {
        for p in $installed; do
          echo -e "\e[32m$p âœ…\e[0m"
        done
        echo "$available"
      } | sort -u
    )
  fi

  pkg=$(echo "$package_list" | \
    fzf --ansi \
        --prompt="ğŸ” Search package: " \
        --header=$'â¬†â¬‡ Navigate | â Select | Ctrl-C Back\nGreen = Installed âœ… | White = Available' \
        --height=40% \
        --reverse \
        --preview 'dnf info {1} 2>/dev/null' \
        --preview-window=down:wrap:60%)

  # If user canceled, return to main menu
  [ -z "$pkg" ] && continue

  # Clean package name
  clean_pkg=$(echo "$pkg" | sed 's/ âœ…//' | sed 's/\x1b\[[0-9;]*m//g')

  # ===== ACTION MENU =====
  if echo "$installed" | grep -qx "$clean_pkg"; then
    action=$(printf "ğŸ“¦ Reinstall\nğŸ—‘ï¸ Remove\nâ¬†ï¸ Update\nâ†©ï¸ Back" | \
      fzf --prompt="Choose action: " \
          --header="Selected (installed): $clean_pkg" \
          --height=20% \
          --reverse)
  else
    action=$(printf "ğŸ“¦ Install\nâ†©ï¸ Back" | \
      fzf --prompt="Choose action: " \
          --header="Selected (available): $clean_pkg" \
          --height=20% \
          --reverse)
  fi

  case "$action" in
    "ğŸ“¦ Install")   sudo dnf install -y "$clean_pkg" ;;
    "ğŸ“¦ Reinstall") sudo dnf reinstall -y "$clean_pkg" ;;
    "ğŸ—‘ï¸ Remove")    sudo dnf remove -y "$clean_pkg" ;;
    "â¬†ï¸ Update")    sudo dnf upgrade -y "$clean_pkg" ;;
    "â†©ï¸ Back" | "") continue ;;
  esac
done
